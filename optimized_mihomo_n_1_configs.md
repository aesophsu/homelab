# Optimized mihomo + AdGuardHome + nftables configs for N1 single-arm transparent router

This document contains the fully optimized config files (ready-to-deploy). **Do not copy/paste fragments — use the full file blocks below.** Replace placeholders only if noted.

---

## 1) /etc/mihomo/mihomo-nftables.nft

```nft
#!/usr/sbin/nft -f

# Optimized nftables for N1 single-arm transparent router
# Variables
define LAN_IP = 10.0.0.2
define N1_MAC = fc:7c:02:d0:b1:7d

table inet mihomo_mangle {
    chain prerouting {
        type filter hook prerouting priority mangle; policy accept;

        # 1. Skip loopback
        iifname "lo" return

        # 2. Skip packets originating from this host (N1)
        ip saddr $LAN_IP return

        # 3. Skip destinations that are local/private/multicast
        ip daddr {127.0.0.0/8, 10.0.0.0/27, 172.16.0.0/12, 192.168.0.0/16, 224.0.0.0/4} return

        # 4. Avoid proxying traffic destined to the main router (prevent loops)
        ip daddr 10.0.0.1 return

        # 5. Avoid proxying traffic destined to N1 itself (by MAC) to prevent accidental local interception
        ether daddr $N1_MAC return

        # 6. Skip AdGuardHome, mihomo listen ports and DNS ports
        tcp dport {7890, 1053, 53} return
        udp dport {7890, 1053, 53} return

        # 7. Mark and TProxy: mark traffic then tproxy to local proxy
        #    We set fwmark=0x1 and TPROXY to local IP:7890
        meta l4proto {tcp, udp} mark set 0x1
        meta l4proto {tcp, udp} tproxy ip to $LAN_IP:7890
    }

    chain output {
        type route hook output priority mangle; policy accept;

        # 1. Drop invalid/skip local/private destinations
        ip daddr {127.0.0.0/8, 10.0.0.0/27, 172.16.0.0/12, 192.168.0.0/16, 224.0.0.0/4} return

        # 2. Skip traffic generated by mihomo process (use numeric UID)
        #    UID for `mihomo` on this system: 999
        meta skuid 999 return

        # 3. Skip DNS from local processes
        tcp dport 53 return
        udp dport 53 return

        # 4. Skip traffic to main router
        ip daddr 10.0.0.1 return

        # 5. Mark remaining local TCP/UDP for policy routing
        meta l4proto {tcp, udp} mark set 0x1
    }
}

# NAT table: redirect LAN client DNS to local AdGuardHome
table inet mihomo_nat {
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;

        # Only apply to traffic coming from LAN (eth0) and not from N1 itself
        iif "eth0" ip saddr != $LAN_IP tcp dport 53 redirect to :53
        iif "eth0" ip saddr != $LAN_IP udp dport 53 redirect to :53
    }
}

# Filter table: strict input policy with necessary allowances
table inet mihomo_filter {
    chain input {
        type filter hook input priority filter; policy drop;

        iifname "lo" accept
        ct state {established, related} accept
        ct state invalid drop

        # Allow SSH and management UIs
        tcp dport {22, 3000, 9090} accept

        # Allow AdGuardHome and Mihomo control ports from local host
        ip saddr $LAN_IP tcp dport {53,1053,7890} accept
        ip saddr $LAN_IP udp dport {53,1053,7890} accept

        # Optional: allow ICMP for diagnostics from LAN
        icmp type echo-request accept
    }
}
```

---

## 2) /etc/systemd/system/mihomo-net.service

```ini
[Unit]
Description=Mihomo Network Setup (NFTables + Policy Routing)
After=network.target
Before=mihomo-tproxy.service
Wants=mihomo-tproxy.service

[Service]
Type=oneshot
RemainAfterExit=yes
User=root

# Enable forwarding and harden IP stack for single-arm routing
ExecStartPre=/sbin/sysctl -w net.ipv4.ip_forward=1
ExecStartPre=/sbin/sysctl -w net.ipv4.conf.all.route_localnet=1
ExecStartPre=/sbin/sysctl -w net.ipv4.conf.eth0.route_localnet=1
ExecStartPre=/sbin/sysctl -w net.ipv4.conf.all.accept_redirects=0
ExecStartPre=/sbin/sysctl -w net.ipv4.conf.all.send_redirects=0

# Clear and set up policy routing table 100
ExecStartPre=/bin/sh -c '/usr/sbin/ip route flush table 100 2>/dev/null || true'
ExecStartPre=/usr/sbin/ip route add local 0.0.0.0/0 dev lo table 100
ExecStartPre=/bin/sh -c '/usr/sbin/ip rule del fwmark 0x1 table 100 2>/dev/null || true'

# Apply nftables rules
ExecStart=/usr/sbin/nft -f /etc/mihomo/mihomo-nftables.nft

# Post-start: ensure fwmark rule is applied
ExecStartPost=/bin/sh -c '/usr/sbin/ip rule del fwmark 0x1 table 100 2>/dev/null || true'
ExecStartPost=/usr/sbin/ip rule add fwmark 0x1 table 100

# Cleanup on stop
ExecStop=/usr/sbin/nft delete table inet mihomo_mangle || true
ExecStopPost=/bin/sh -c '/usr/sbin/ip rule del fwmark 0x1 table 100 2>/dev/null || true'
ExecStopPost=/bin/sh -c '/usr/sbin/ip route flush table 100 2>/dev/null || true'

Restart=no
TimeoutSec=10

[Install]
WantedBy=multi-user.target
```

---

## 3) /etc/systemd/system/mihomo-tproxy.service

```ini
[Unit]
Description=Mihomo TProxy Daemon
After=mihomo-net.service
Requires=mihomo-net.service

[Service]
Type=simple
User=mihomo
Group=mihomo
WorkingDirectory=/etc/mihomo

# Limit capabilities to what is required and sandbox service
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=read-only
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectControlGroups=yes

# Start Mihomo
ExecStart=/etc/mihomo/mihomo -d /etc/mihomo
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=5
LimitNOFILE=65536
StandardOutput=syslog
StandardError=syslog

[Install]
WantedBy=multi-user.target
```

---

## 4) /etc/systemd/system/adguardhome.service

```ini
[Unit]
Description=AdGuard Home DNS server
After=network.target mihomo-tproxy.service
Wants=mihomo-tproxy.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/.config/adguardhome

# Start AdGuardHome
ExecStart=/usr/local/bin/AdGuardHome -c /root/.config/adguardhome/AdGuardHome.yaml -w /root/.config/adguardhome
Restart=always
RestartSec=5
StandardOutput=syslog
StandardError=syslog
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

---

## Notes & next steps
1. Files assume `mihomo` UID=999 and N1 MAC `fc:7c:02:d0:b1:7d` — both supplied by you.
2. Put the nftables file at `/etc/mihomo/mihomo-nftables.nft` and the systemd units in `/etc/systemd/system/`.
3. Commands to apply (run as root):

```sh
# place files, then
systemctl daemon-reload
systemctl enable --now mihomo-net.service
systemctl enable --now mihomo-tproxy.service
systemctl enable --now adguardhome.service

# verify nft rules
nft list ruleset

# verify ip rule
ip rule show

# test: from a LAN device, curl an external site and check mihomo logs
```

4. If you have `iptables`-based scripts or previous nftables remnants, ensure they are removed to avoid conflicts.

---

If you want, I can also:
- produce a short troubleshooting checklist (conn tracking, where to look for dropped packets),
- produce a minimal `mihomo` config example to pair with this nftables file,
- or generate a small system test script that validates the policy routing and DNS redirection.

